{% extends 'province/base.html' %}
{% load static %}

{% block title %}Province Analysis{% endblock %}

{% block content %}
<div class="container">

    <div class="header">
        <h1>Province Analysis</h1>
        <p>Analyze dynasty structures and family name distributions by province and year</p>
    </div>

    <a href="{% url 'overview:dashboard' %}" class="back-link">‚Üê Back to Dashboard</a>
    

    <div class="content-grid">
        <!-- Controls sidebar -->
        <div class="controls-section">
            <div class="controls-header">Select Options</div>
            <form method="get">
                <div class="form-group">
                    <label for="province">Select a Province</label>
                    <select class="form-control" name="province" id="province">
                        {% for province in provinces %}
                            <option value="{{ province }}" {% if province == selected_province %}selected{% endif %}>
                                {{ province }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="year">Select a Year</label>
                    <select class="form-control" name="year" id="year">
                        {% for year in years %}
                            <option value="{{ year }}" {% if year == selected_year %}selected{% endif %}>
                                {{ year }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <button type="submit" class="btn" style="background-color: #007bff; color: white; border-color: #007bff;">Update Analysis</button>
            </form>
        </div>

        <!-- Main content area -->
        <div>
            <h2 style="margin-bottom: 20px; color: #333;">Analysis for {{ selected_province }} ({{ selected_year }})</h2>
            
            <!-- Family Name Analysis -->
            <div class="chart-section">
                <div class="chart-header">Largest Family Dynasty</div>
                <div class="chart-content">
                    {% if top_family_warning %}
                        <div class="alert">{{ top_family_warning }}</div>
                    {% else %}
                        <div id="top-family-card"></div>
                        <div id="top-family-politicians-card"></div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Dynasty Sizes -->
            <div class="chart-section">
                <div class="chart-header">Dynasty Sizes and Family Names</div>
                <div class="chart-content">
                    {% if dynasty_warning %}
                        <div class="alert">{{ dynasty_warning }}</div>
                    {% else %}
                        <div id="dynasty-chart"></div>
                        <p style="text-align: center; color: #666; font-size: 0.9em; margin-top: 15px; font-style: italic;">
                            Only showed communities with at least 3 members
                        </p>
                    {% endif %}
                </div>
            </div>
            
            <!-- Concentration Analysis -->
            <div class="chart-section">
                <div class="chart-header">Family Name Concentration vs Position Weight</div>
                <div class="chart-content">
                    {% if concentration_warning %}
                        <div class="alert">{{ concentration_warning }}</div>
                    {% else %}
                        <div id="concentration-chart"></div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    {% if top_family %}
    const topFamilyCardContainer = document.getElementById('top-family-card');
    const topFamilyPoliticiansContainer = document.getElementById('top-family-politicians-card');
    if (topFamilyCardContainer) {
        topFamilyCardContainer.innerHTML = `
            <div style="
                background-color: #f0f8ff; 
                border: 1px solid #4682b4; 
                padding: 20px; 
                border-radius: 10px; 
                width: fit-content;
                font-family: Arial, sans-serif;
                box-shadow: 2px 2px 10px rgba(0,0,0,0.1);
                margin: 20px auto;
                text-align: center;
                display: flex;
                flex-direction: column;
                align-items: center;
            ">
                <strong style="font-size: 1.1em; margin-bottom: 8px;">Most Prominent Family Name:</strong>
                <span style="color: #1f4e79; font-size: 1.5em; font-weight: 600; margin-bottom: 5px;">
                    {{ top_family.Family }}
                </span>
                <span style="font-weight: bold; color: #d9534f; font-size: 1.1em;">
                    {{ top_family.Count }} Family Members
                </span>
            </div>
        `;
    }
        if (topFamilyPoliticiansContainer) {
        topFamilyPoliticiansContainer.innerHTML = `
            <div style="
                background-color: #fff8dc; 
                border: 1px solid #daa520; 
                padding: 15px; 
                border-radius: 10px; 
                width: fit-content;
                font-family: Arial, sans-serif;
                box-shadow: 2px 2px 8px rgba(0,0,0,0.1);
                margin: 10px auto;
                text-align: center;
            ">
                <strong style="font-size: 1.1em; margin-bottom: 8px; display: block;">Politicians in this Family:</strong>
                <ul style="list-style-type: disc; margin: 0; padding-left: 20px; text-align: left;">
                    {% for politician in top_family.Politicians %}
                        <li>{{ politician }}</li>
                    {% endfor %}
                </ul>
            </div>
        `;
    }
    {% endif %}
        
    {% if dynasty_chart %}
    var dynastyChart = JSON.parse('{{ dynasty_chart|escapejs }}');
    Plotly.newPlot('dynasty-chart', dynastyChart.data, dynastyChart.layout);
    {% endif %}
    
    {% if concentration_chart %}
    var concentrationChart = JSON.parse('{{ concentration_chart|escapejs }}');
    Plotly.newPlot('concentration-chart', concentrationChart.data, concentrationChart.layout);
    {% endif %}
</script>
{% endblock %}
